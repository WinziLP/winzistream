<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Winzi – Live auf Twitch & Kick</title>
  <meta name="description" content="Offizielle Landingpage von Winzi – Streamer auf Twitch & Kick. Folge für Livestreams, Updates und Community." />
  <link rel="canonical" href="https://winzi.stream" />
  <meta name="theme-color" content="#160b22" />
  <meta name="color-scheme" content="dark light">

  <!-- Preconnect / Prefetch -->
  <link rel="preconnect" href="https://player.twitch.tv" crossorigin>
  <link rel="preconnect" href="https://static.twitchcdn.net" crossorigin>
  <link rel="preconnect" href="https://player.kick.com" crossorigin>
  <link rel="preconnect" href="https://status.winzi.stream" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="//player.twitch.tv">
  <link rel="dns-prefetch" href="//player.kick.com">
  <link rel="dns-prefetch" href="//status.winzi.stream">

  <!-- Live-Status Endpoints -->
  <meta name="status-endpoint" content="https://status.winzi.stream/winzi.json">
  <meta name="status-sse" content="https://status.winzi.stream/winzi.sse">

  <!-- Twitch parents -->
  <meta name="twitch-parents" content="winzi.stream,www.winzi.stream,localhost,127.0.0.1">

  <!-- Twitch Embed JS-API -->
  <script src="https://player.twitch.tv/js/embed/v1.js" defer></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,500;0,600;1,400&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#120a1b; --bg-2:#1d1230; --text:#f2f3f5; --muted:#9aa0ab;
      --kick:#00E701; --twitch:#9147ff; --card:#0f1322; --ring:rgba(255,75,209,.55);
      --shadow:0 10px 25px rgba(0,0,0,.35); --radius:1.25rem; --radius-lg:1.5rem;
      --maxw:1280px; --header-h:64px;
      --font-display:"Roboto Condensed",system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      --font-body:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      scroll-behavior:smooth;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;font-family:var(--font-body);color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(255,75,209,.28), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(165,107,255,.20), transparent 60%),
        linear-gradient(180deg,var(--bg),var(--bg-2));
      background-attachment:fixed;line-height:1.6;
      display:grid;grid-template-rows:auto 1fr auto;min-height:100svh;
    }
    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg,rgba(18,10,27,.82),rgba(18,10,27,.36));
      border-bottom:1px solid rgba(255,255,255,.06)}
    .nav{max-width:var(--maxw);margin:0 auto;padding:.6rem 1rem;display:flex;align-items:center;justify-content:space-between;min-height:var(--header-h)}
    .brand{display:flex;align-items:center;text-decoration:none;color:var(--text)}
    .brand span{font-size:1.05rem;font-weight:800;letter-spacing:.5px}

    main{max-width:var(--maxw);margin:0 auto;padding:clamp(1rem,3vw,2rem) 1rem;display:grid;align-items:center;min-height:calc(100svh - var(--header-h))}
    .hero{display:grid;gap:2rem;align-items:center;grid-template-columns:1fr 1.3fr;min-height:100%;
      contain:content}
    .eyebrow{font:800 .85rem/1 var(--font-body);letter-spacing:.12em;text-transform:uppercase;color:var(--muted);opacity:.85}
    .hero h1{font-family:var(--font-display);font-size:clamp(3rem,8vw,5.4rem);line-height:1.05;margin:.2rem 0 .65rem;text-transform:uppercase;font-weight:600;font-style:italic;position:relative;transform:skewX(-8deg);color:#fff;text-shadow:0 12px 28px rgba(0,0,0,.35)}
    .sub{color:var(--muted);max-width:55ch}
    .cta{display:flex;gap:.5rem;margin-top:1.1rem;flex-wrap:wrap}
    .btn{--btn-bg:var(--card);--btn-bd:rgba(255,255,255,.09);--btn-tx:var(--text);
      display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .8rem;border-radius:.9rem;border:1px solid var(--btn-bd);
      text-decoration:none;color:var(--btn-tx);background:var(--btn-bg);box-shadow:var(--shadow);
      transition:transform .2s ease,box-shadow .2s ease,background .2s ease,opacity .2s ease;
      font-weight:800;text-transform:uppercase;letter-spacing:.02em;font-size:.92rem;white-space:nowrap;will-change:transform}
    .btn:hover{transform:translateY(-2px);box-shadow:0 16px 35px rgba(0,0,0,.45)}
    .btn:focus{outline:3px solid var(--ring);outline-offset:2px}
    .btn .ico{width:18px;height:18px}
    .btn .live-pill{display:none;font-size:.75rem;font-weight:800;padding:.15rem .4rem;border-radius:.5rem;background:#ef4444;color:#fff;letter-spacing:.06em}
    .btn.live .live-pill{display:inline-block}
    .btn.twitch{background:transparent;border-color:rgba(145,71,255,.55);color:var(--twitch)}
    .btn.twitch:hover{background:var(--twitch);border-color:var(--twitch);color:#fff}
    .btn.kick{background:transparent;border-color:rgba(0,231,1,.55);color:#5CF457}
    .btn.kick:hover{background:var(--kick);border-color:var(--kick);color:#0b0b0b}

    .hero-card{position:relative;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius-lg);padding:1.25rem;box-shadow:var(--shadow);backdrop-filter:saturate(120%) blur(6px);overflow:hidden;contain:content}
    .embed-wrap{display:grid;gap:1rem}
    .tabs{display:flex;gap:.5rem;position:relative;z-index:2;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:.25rem;scroll-snap-type:x proximity}
    .tab-btn{appearance:none;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);color:var(--text);padding:.6rem .8rem;border-radius:.75rem;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:.45rem;text-transform:uppercase;letter-spacing:.02em;min-height:42px;scroll-snap-align:start}
    .tab-btn[aria-selected="true"]{background:rgba(255,255,255,.16);border-color:rgba(255,255,255,.32)}
    .tab-btn.offline{opacity:.45;filter:saturate(.4) contrast(.9);cursor:not-allowed;pointer-events:none}
    .tab-btn .mini{width:16px;height:16px;vertical-align:-3px}
    .tab-btn .live-dot{display:none;width:8px;height:8px;border-radius:999px;background:#ef4444;box-shadow:0 0 0 4px rgba(239,68,68,.2)}
    .tab-btn.online .live-dot{display:inline-block}
    #tab-twitch.online{border-color:rgba(145,71,255,.55)}
    #tab-kick.online{border-color:rgba(0,231,1,.55)}
    #tab-twitch[aria-selected="true"]{background:rgba(145,71,255,.15)}
    #tab-kick[aria-selected="true"]{background:rgba(0,231,1,.12)}

    .player,.player-host{aspect-ratio:16/9;width:100%;border:0;border-radius:calc(var(--radius) - .25rem);background:#0a0f19;opacity:0;transition:opacity .2s ease;position:relative;overflow:hidden;display:block}
    .player.show,.player-host.show{opacity:1}
    #twitch-host{position:relative}
    #twitch-host iframe{position:absolute !important;inset:0 !important;width:100% !important;height:100% !important;border:0 !important;border-radius:inherit;display:block}

    .offline-box{display:flex;align-items:center;justify-content:center;gap:.75rem;text-align:center;flex-direction:column;aspect-ratio:16/9;background:#0a0f19;border-radius:calc(var(--radius) - .25rem);border:1px dashed rgba(255,255,255,.15);color:#cbd5e1;font-weight:800;letter-spacing:.02em;padding:1rem}
    .offline-box.hidden{display:none}
    .error-box{display:none;align-items:center;justify-content:center;gap:.75rem;text-align:center;flex-direction:column;aspect-ratio:16/9;background:#0a0f19;border-radius:calc(var(--radius) - .25rem);border:1px solid rgba(239,68,68,.35);color:#fecaca;font-weight:800;letter-spacing:.02em;padding:1rem}
    .error-box.show{display:flex}

    .site-footer{max-width:var(--maxw);margin:2rem auto 1rem;padding:1.25rem 1rem 2rem;color:var(--muted);position:relative;font-size:.95rem;content-visibility:auto;contain-intrinsic-size: 800px}
    .site-footer::before{content:"";position:absolute;left:50%;transform:translateX(-50%);top:0;width:100vw;height:1px;background:rgba(255,255,255,.08)}
    .footer-top{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
    .footer-links{display:flex;flex-direction:column;gap:.25rem}
    .footer-links a{color:var(--muted);text-decoration:none;font-weight:500;opacity:.9}
    .footer-bottom{margin-top:.75rem;padding-top:.6rem;font-size:.85rem;text-align:center;position:relative}
    .footer-bottom::before{content:"";position:absolute;left:50%;transform:translateX(-50%);top:0;width:100vw;height:1px;background:rgba(255,255,255,.06)}

    @media (max-width:1024px){.hero{grid-template-columns:1fr}.cta{justify-content:center}}
    @media (max-width:560px){.btn{width:100%;justify-content:center}}
    @media (prefers-reduced-motion: reduce){
      .btn,.player,.player-host{transition:none}
    }
  </style>
</head>
<body>
<header>
  <div class="nav"><a class="brand" href="#top"><span>WINZI</span></a></div>
</header>

<main id="top">
  <section class="hero" aria-labelledby="hero-title">
    <div>
      <p class="eyebrow">Streamer & Community</p>
      <h1 id="hero-title">WINZI</h1>
      <p class="sub">Komm vorbei, häng mit der Community ab und verpass keine Streams mehr – live auf <strong>Twitch</strong> &amp; <strong>Kick</strong>.</p>
      <div class="cta">
        <a id="btn-twitch" class="btn twitch" target="_blank" rel="noopener" href="https://twitch.tv/winzilp">
          <svg class="ico" viewBox="0 0 24 24"><use href="#ico-twitch"/></svg> Auf Twitch folgen <span class="live-pill">LIVE</span>
        </a>
        <a id="btn-kick" class="btn kick" target="_blank" rel="noopener" href="https://kick.com/winzi">
          <svg class="ico" viewBox="0 0 24 24"><use href="#ico-kick"/></svg> Auf Kick folgen <span class="live-pill">LIVE</span>
        </a>
      </div>
    </div>

    <div class="hero-card" id="hero-card">
      <div class="embed-wrap">
        <div class="tabs" role="tablist">
          <button type="button" id="tab-twitch" class="tab-btn offline" role="tab" aria-selected="false" aria-controls="panel-twitch" aria-disabled="true" disabled>
            <svg class="mini" viewBox="0 0 24 24"><use href="#ico-twitch"/></svg> Twitch <span class="live-dot"></span>
          </button>
          <button type="button" id="tab-kick" class="tab-btn offline" role="tab" aria-selected="false" aria-controls="panel-kick" aria-disabled="true" disabled>
            <svg class="mini" viewBox="0 0 24 24"><use href="#ico-kick"/></svg> Kick <span class="live-dot"></span>
          </button>
        </div>

        <div id="panel-twitch" role="tabpanel" aria-labelledby="tab-twitch" hidden>
          <div id="twitch-host" class="player-host"></div>
        </div>

        <div id="panel-kick" role="tabpanel" aria-labelledby="tab-kick" hidden>
          <iframe id="kick-player" class="player"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
            referrerpolicy="strict-origin-when-cross-origin"
            loading="lazy" fetchpriority="high"></iframe>
        </div>

        <div id="offline-box" class="offline-box">Currently Offline :c</div>
        <div id="embed-error" class="error-box">
          <div>Der Twitch-Player kann in einer lokalen Datei (file://) nicht eingebettet werden.</div>
          <div style="font-weight:600">Öffne den Stream extern oder starte die Seite über http://localhost:</div>
          <div class="cta" style="margin-top:.5rem">
            <a class="btn twitch" href="https://twitch.tv/winzilp" target="_blank" rel="noopener"><svg class="ico" viewBox="0 0 24 24"><use href="#ico-twitch"/></svg> Auf Twitch ansehen</a>
            <a class="btn kick" href="https://kick.com/winzi" target="_blank" rel="noopener"><svg class="ico" viewBox="0 0 24 24"><use href="#ico-kick"/></svg> Auf Kick ansehen</a>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="footer-top">
    <nav class="footer-links" aria-label="Kanäle">
      <a class="twitch" href="https://twitch.tv/winzilp" target="_blank" rel="noopener">Twitch</a>
      <a class="kick" href="https://kick.com/winzi" target="_blank" rel="noopener">Kick</a>
    </nav>
    <nav class="footer-links" aria-label="Kontakt">
      <a href="mailto:winzibusiness@gmail.com">winzibusiness@gmail.com</a>
    </nav>
  </div>
  <div class="footer-bottom">© <span id="year"></span> Winzi. Alle Rechte vorbehalten.</div>
</footer>

<!-- Inline Icons -->
<svg width="0" height="0" style="position:absolute;width:0;height:0;overflow:hidden" aria-hidden="true" focusable="false">
  <defs>
    <symbol id="ico-twitch" viewBox="0 0 512 512">
      <path fill="currentColor" d="M80 0L32 96v320h128v96l96-96h128l96-96V0H80zm352 256l-64 64H256l-64 64v-64h-64V64h304v192zM336 112h48v112h-48V112zm-112 0h48v112h-48V112z"/>
    </symbol>
    <symbol id="ico-kick" viewBox="0 0 26 26">
      <path fill-rule="evenodd" clip-rule="evenodd" d="M1 0H9.76711V5.79452H12.589V2.82193H15.5616V0H24.1781V8.61645H21.3561V11.589H18.3836V14.411H21.3561V17.3836H24.1781V26H15.5616V23.1781H12.589V20.2055H9.76711V26H1V0Z" fill="currentColor"/>
    </symbol>
  </defs>
</svg>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  (function setupEmbeds(){
    const twitchBtn = document.getElementById('tab-twitch');
    const kickBtn   = document.getElementById('tab-kick');
    const twitchPanel = document.getElementById('panel-twitch');
    const kickPanel   = document.getElementById('panel-kick');
    const offlineBox  = document.getElementById('offline-box');
    const embedErrorBox = document.getElementById('embed-error');
    const btnTwitch = document.getElementById('btn-twitch');
    const btnKick   = document.getElementById('btn-kick');
    const heroCard  = document.getElementById('hero-card');
    const twitchHost = document.getElementById('twitch-host');

    let state = {
      twitchLive:false, kickLive:false,
      current:'twitch',
      userInteracted:false,
      heroInView:true,
      kickSavedSrc:""
    };

    let twitchPlayer = null;
    let twitchRO = null;
    let es = null; // EventSource Handle
    let pollingTimer = null;

    // --- Kick helpers
    const getKickEl = () => document.getElementById('kick-player');
    const buildKickEl = () => {
      const el = document.createElement('iframe');
      el.id = 'kick-player';
      el.className = 'player';
      el.allowFullscreen = true;
      el.setAttribute('allow','autoplay; fullscreen; picture-in-picture');
      el.setAttribute('referrerpolicy','strict-origin-when-cross-origin');
      el.setAttribute('loading','lazy');
      el.setAttribute('fetchpriority','high');
      return el;
    };

    // --- Twitch helpers
    function canEmbedTwitch(){
      const proto = location.protocol, host = location.hostname;
      if (proto === 'https:') return true;
      if (proto === 'http:' && (host === 'localhost' || host === '127.0.0.1')) return true;
      return false;
    }
    function twitchParents(){
      const meta = document.querySelector('meta[name="twitch-parents"]')?.content || '';
      const p = meta.split(',').map(s=>s.trim()).filter(Boolean);
      const h = location.hostname; if (h && !p.includes(h)) p.push(h);
      ['localhost','127.0.0.1'].forEach(d=>{ if(!p.includes(d)) p.push(d); });
      return p;
    }
    function initTwitch(muted){
      if (!canEmbedTwitch()) return;
      if (!window.Twitch || !window.Twitch.Player) return;
      if (twitchPlayer) { try { twitchPlayer.setMuted(!!muted); } catch(e){} return; }

      const make = () => {
        const w = twitchHost.clientWidth || 1280;
        const h = Math.round(w * 9/16);
        twitchPlayer = new Twitch.Player('twitch-host', {
          channel: 'winzilp',
          parent: twitchParents(),
          autoplay: true,
          muted: !!muted,
          width: w,
          height: h
        });
        twitchPlayer.addEventListener(Twitch.Player.READY, ()=>{
          twitchHost.classList.add('show');
          setTimeout(()=> window.dispatchEvent(new Event('resize')), 50);
        });
        if ('ResizeObserver' in window && !twitchRO){
          twitchRO = new ResizeObserver(()=> window.dispatchEvent(new Event('resize')));
          twitchRO.observe(twitchHost);
        }
      };
      requestAnimationFrame(()=> requestAnimationFrame(make));
    }
    function playTwitch(withAudio){
      if (!twitchPlayer) { initTwitch(!withAudio); }
      try {
        if (twitchPlayer){
          twitchPlayer.setMuted(!withAudio);
          twitchPlayer.play();
          setTimeout(()=> window.dispatchEvent(new Event('resize')), 0);
        }
      } catch(e){}
    }
    function pauseTwitch(){ try { twitchPlayer && twitchPlayer.pause(); } catch(e){} }
    function destroyTwitch(){ try{ twitchPlayer && twitchPlayer.pause(); }catch(e){} /* API bietet kein destroy */ }

    // --- Kick URL
    function kickURL(muted){
      const u = new URL('https://player.kick.com/winzi');
      u.searchParams.set('autoplay','true');
      u.searchParams.set('muted', String(!!muted));
      u.searchParams.set('playsinline','1');
      return u.toString();
    }
    function resumeKick(withAudio){
      let el = getKickEl();
      if (!el){ el = buildKickEl(); kickPanel.appendChild(el); }
      const want = state.kickSavedSrc || kickURL(!withAudio ? true : false);
      if (el.src !== want) el.src = want;
      requestAnimationFrame(()=> el.classList.add('show'));
    }
    function pauseKick(){
      const el = getKickEl();
      if (!el) return;
      if (el.src && !el.src.startsWith('about:')) state.kickSavedSrc = el.src;
      try { el.src = 'about:blank'; } catch(e){}
      setTimeout(()=>{
        if (el.isConnected) el.remove();
        if (!getKickEl()) kickPanel.appendChild(buildKickEl()); // Placeholder
      },0);
    }

    // --- Render (debounced via rAF)
    let rafId=null;
    function scheduleRender(){ if (rafId) return; rafId = requestAnimationFrame(()=>{ rafId=null; render(); }); }

    function render(){
      const tOff = !state.twitchLive, kOff = !state.kickLive;

      twitchBtn.classList.toggle('online', !tOff);
      kickBtn.classList.toggle('online', !kOff);
      twitchBtn.classList.toggle('offline', tOff);
      kickBtn.classList.toggle('offline', kOff);
      twitchBtn.disabled = tOff; twitchBtn.setAttribute('aria-disabled', String(tOff));
      kickBtn.disabled   = kOff;   kickBtn.setAttribute('aria-disabled', String(kOff));

      btnTwitch.classList.toggle('live', state.twitchLive);
      btnKick.classList.toggle('live', state.kickLive);

      const showT = (state.current === 'twitch' && state.twitchLive && state.heroInView);
      const showK = (state.current === 'kick'   && state.kickLive   && state.heroInView);

      twitchPanel.hidden = !showT;
      kickPanel.hidden   = !showK;

      const allowAudio = state.userInteracted && document.visibilityState==='visible' && state.heroInView;

      if (showT && canEmbedTwitch()) { initTwitch(!allowAudio); playTwitch(allowAudio); } else { pauseTwitch(); }
      if (showK) { resumeKick(allowAudio); } else { pauseKick(); }

      const noOneLive = !state.twitchLive && !state.kickLive;
      offlineBox.classList.toggle('hidden', !noOneLive);

      const showEmbedError = showT && !canEmbedTwitch();
      embedErrorBox.classList.toggle('show', showEmbedError);

      twitchBtn.setAttribute('aria-selected', String(state.current === 'twitch'));
      kickBtn.setAttribute('aria-selected', String(state.current === 'kick'));

      if (showT) twitchHost.classList.add('show'); else twitchHost.classList.remove('show');
      const kEl = getKickEl(); if (kEl) { if (showK) kEl.classList.add('show'); else kEl.classList.remove('show'); }

      // Watchdog: wenn Twitch aktiv ist, darf kein Kick-iframe mit echter src im DOM bleiben
      if (state.current === 'twitch'){
        const el = getKickEl();
        if (el && el.src && !el.src.startsWith('about:')) pauseKick();
      }
      // Twitch-RO sparen, wenn Twitch nicht sichtbar
      if (twitchRO){
        if (!showT) try{ twitchRO.disconnect(); twitchRO=null; }catch(e){}
      }
    }

    function show(which){
      if (which === 'twitch' && !state.twitchLive) return;
      if (which === 'kick'   && !state.kickLive)   return;
      state.current = which; scheduleRender();
    }

    // Events (passive wo sinnvoll)
    twitchBtn.addEventListener('click', ()=>{ state.userInteracted = true; show('twitch'); }, {passive:true});
    kickBtn.addEventListener('click',  ()=>{ state.userInteracted = true; show('kick');  }, {passive:true});
    heroCard.addEventListener('pointerdown', ()=>{ state.userInteracted = true; }, {passive:true});

    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState !== 'visible'){ pauseTwitch(); pauseKick(); stopSSE(); }
      else { maybeStartLive(); }
      scheduleRender();
    });

    const io = new IntersectionObserver((entries)=>{
      const e = entries[0];
      state.heroInView = e && e.isIntersecting && e.intersectionRatio >= 0.5;
      if (!state.heroInView){ pauseTwitch(); pauseKick(); stopSSE(); }
      else { maybeStartLive(); }
      scheduleRender();
    }, { threshold:[0,0.5,1], rootMargin:"0px" });
    io.observe(heroCard);

    // Initial
    render();

    // ---- Live-Status: SSE on-demand, sonst Backoff-Polling
    const STATUS_ENDPOINT = document.querySelector('meta[name="status-endpoint"]')?.content || '';
    const STATUS_SSE      = document.querySelector('meta[name="status-sse"]')?.content || '';

    function applyLive(t,k){
      const prev = {t:state.twitchLive,k:state.kickLive,cur:state.current};
      state.twitchLive = !!t; state.kickLive = !!k;
      if (state.twitchLive && canEmbedTwitch()) state.current = 'twitch';
      else if (state.kickLive) state.current = 'kick';
      else state.current = 'twitch';
      if (prev.t!==state.twitchLive || prev.k!==state.kickLive || prev.cur!==state.current) scheduleRender();
    }

    function supportsSSE(){ return typeof window.EventSource !== 'undefined'; }

    function startSSE(){
      if (es || !supportsSSE() || !STATUS_SSE) return;
      es = new EventSource(STATUS_SSE);
      es.addEventListener('message', ev => { try{ const d=JSON.parse(ev.data); applyLive(!!d.twitch, !!d.kick); }catch{} });
      es.addEventListener('error', ()=>{ stopSSE(); startPolling(true); });
    }
    function stopSSE(){ if (es){ try{ es.close(); }catch{} es=null; } }

    function startPolling(immediate=false){
      clearTimeout(pollingTimer);
      const TTL_VISIBLE = 10000, TTL_HIDDEN = 45000;
      let etag='', last={t:false,k:false};
      const fetchStatus = async ()=>{
        try{
          const h = etag ? {'If-None-Match': etag} : {};
          const res = await fetch(STATUS_ENDPOINT, {headers:h, cache:'no-store'});
          if (res.status === 304) return last;
          if (!res.ok) return null;
          etag = res.headers.get('ETag') || '';
          const j = await res.json();
          last = {t:!!j.twitch,k:!!j.kick};
          return last;
        }catch{return null}
      };
      const tick = async ()=>{
        clearTimeout(pollingTimer);
        const r = await fetchStatus();
        if (r) applyLive(r.t, r.k);
        const busy = (state.twitchLive || state.kickLive);
        const base = (document.visibilityState==='visible'?TTL_VISIBLE:TTL_HIDDEN);
        const next = Math.max(6000, base * (busy?0.6:1.2));
        pollingTimer = setTimeout(tick, next);
      };
      if (immediate) tick(); else pollingTimer = setTimeout(tick, 1);
    }
    function stopPolling(){ clearTimeout(pollingTimer); pollingTimer=null; }

    function maybeStartLive(){
      // Dev override ?live=...
      const liveParam = new URLSearchParams(location.search).get('live');
      if (liveParam) {
        const map = {twitch:[true,false],kick:[false,true],both:[true,true],none:[false,false]};
        if (map[liveParam]) { applyLive(map[liveParam][0], map[liveParam][1]); return; }
      }
      if (!STATUS_ENDPOINT && !STATUS_SSE) return;

      const visible = document.visibilityState==='visible' && state.heroInView;
      if (visible){
        stopPolling();
        if (STATUS_SSE) startSSE(); else startPolling(true);
      } else {
        stopSSE();
        startPolling(false);
      }
    }

    // Start Live-Status erst idle/bei Sichtbarkeit
    (window.requestIdleCallback || setTimeout)(()=> maybeStartLive(), 500);
  })();
</script>
</body>
</html>
